<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Jurnal Harian — MediZen</title>
<link rel="stylesheet" href="journal.css">
</head>
<body>
<div class="app-shell">

  <div class="journal-page" id="journal-page">

    <div class="journal-header">
      <a href="../home/index.html" class="icon-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
      </a>
      <div class="journal-header-title">Jurnal Harian</div>
      <button class="icon-btn" onclick="openEditor(null)" title="Tulis jurnal baru">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>

    <!-- Mood today -->
    <div class="mood-banner">
      <div class="mood-banner-top">
        <div class="mood-banner-label">Mood Hari Ini</div>
        <div class="mood-banner-date" id="today-label"></div>
      </div>
      <div class="mood-picker" id="mood-picker">
        <div class="mood-option" data-mood="sangat-baik" onclick="selectTodayMood('sangat-baik',this)">
          <div class="mood-icon">&#128513;</div>
          <div class="mood-option-label">Luar Biasa</div>
        </div>
        <div class="mood-option" data-mood="baik" onclick="selectTodayMood('baik',this)">
          <div class="mood-icon">&#128512;</div>
          <div class="mood-option-label">Baik</div>
        </div>
        <div class="mood-option" data-mood="biasa" onclick="selectTodayMood('biasa',this)">
          <div class="mood-icon">&#128528;</div>
          <div class="mood-option-label">Biasa</div>
        </div>
        <div class="mood-option" data-mood="kurang" onclick="selectTodayMood('kurang',this)">
          <div class="mood-icon">&#128544;</div>
          <div class="mood-option-label">Kurang</div>
        </div>
        <div class="mood-option" data-mood="buruk" onclick="selectTodayMood('buruk',this)">
          <div class="mood-icon">&#128549;</div>
          <div class="mood-option-label">Buruk</div>
        </div>
      </div>
    </div>

    <!-- Streak & stats -->
    <div class="streak-row" id="streak-row">
      <div class="streak-box">
        <div class="streak-value" id="streak-val">0</div>
        <div class="streak-label">Hari Berturut</div>
      </div>
      <div class="streak-box">
        <div class="streak-value" id="total-val">0</div>
        <div class="streak-label">Total Entri</div>
      </div>
      <div class="streak-box">
        <div class="streak-value" id="this-month-val">0</div>
        <div class="streak-label">Bulan Ini</div>
      </div>
    </div>

    <!-- 7-day mood recap -->
    <div class="week-mood">
      <div class="week-mood-title">7 Hari Terakhir</div>
      <div class="week-dots" id="week-dots"></div>
    </div>

    <!-- Mood insight -->
    <div class="insight-card" id="insight-card" style="display:none;">
      <div class="insight-title">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent-purple)" stroke-width="2" stroke-linecap="round"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
        Distribusi Mood
      </div>
      <div class="mood-bar-wrap" id="mood-bars"></div>
    </div>

    <!-- Write CTA -->
    <div class="write-btn-wrap">
      <button class="write-btn" onclick="openEditor(null)">
        <div class="write-btn-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </div>
        <div class="write-btn-text">
          <div class="write-btn-headline">Tulis Jurnal Baru</div>
          <div class="write-btn-sub">Refleksi harian untuk kesehatan mental yang lebih baik</div>
        </div>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>

    <!-- Entries list -->
    <div class="j-section-header">
      <div class="j-section-title">Riwayat Jurnal</div>
      <button class="j-filter-btn" onclick="toggleFilter()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
        <span id="filter-label">Semua</span>
      </button>
    </div>

    <div class="journal-list" id="journal-list"></div>

    <div class="journal-empty hidden" id="journal-empty">
      <div class="journal-empty-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </div>
      <div class="journal-empty-title">Belum Ada Jurnal</div>
      <div class="journal-empty-desc">Mulai perjalanan refleksimu. Tulis jurnal pertama hari ini!</div>
      <button class="btn btn-outline btn-sm" style="margin-top:16px;" onclick="openEditor(null)">Tulis Sekarang</button>
    </div>

  </div><!-- /journal-page -->

    <nav class="bottom-nav">
    <a href="../home/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span class="nav-label">Beranda</span>
    </a>
    <a href="../search/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span class="nav-label">Search</span>
    </a>
    <a href="../doctors/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Dokter</span>
    </a>
    <a href="../chatbot/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span class="nav-label">AI Chat</span>
    </a>
    <a href="../profile/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Profil</span>
    </a>
  </nav>

</div><!-- /app-shell -->

<!-- ===== EDITOR MODAL ===== -->
<div class="modal-overlay hidden" id="editor-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="editor-title">Jurnal Baru</div>
      <button class="icon-btn" onclick="closeEditor()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- Mood selector -->
      <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em;">Mood</div>
      <div class="editor-mood-row" id="editor-mood-row">
        <div class="editor-mood-opt selected" data-mood="sangat-baik" onclick="selectEditorMood('sangat-baik',this)"><span>&#128513;</span><span>Luar Biasa</span></div>
        <div class="editor-mood-opt" data-mood="baik" onclick="selectEditorMood('baik',this)"><span>&#128512;</span><span>Baik</span></div>
        <div class="editor-mood-opt" data-mood="biasa" onclick="selectEditorMood('biasa',this)"><span>&#128528;</span><span>Biasa</span></div>
        <div class="editor-mood-opt" data-mood="kurang" onclick="selectEditorMood('kurang',this)"><span>&#128544;</span><span>Kurang</span></div>
        <div class="editor-mood-opt" data-mood="buruk" onclick="selectEditorMood('buruk',this)"><span>&#128549;</span><span>Buruk</span></div>
      </div>

      <!-- Title -->
      <div class="input-group" style="margin-bottom:14px;">
        <div class="input-label">Judul (opsional)</div>
        <input class="input-field" type="text" id="entry-title-input" placeholder="Beri judul jurnalmu...">
      </div>

      <!-- Body -->
      <div class="input-group">
        <div class="input-label">Ceritakan harimu</div>
        <textarea class="journal-textarea" id="entry-body" placeholder="Apa yang kamu rasakan hari ini? Hal apa yang terjadi? Bagaimana kondisi mentalmu?..."></textarea>
        <div class="word-count"><span id="word-count">0</span> kata</div>
      </div>

      <!-- Tags -->
      <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin:14px 0 8px;text-transform:uppercase;letter-spacing:0.05em;">Tag</div>
      <div class="tags-wrap" id="tags-wrap">
        <button class="tag-toggle" onclick="toggleTag(this,'olahraga')">Olahraga</button>
        <button class="tag-toggle" onclick="toggleTag(this,'makan-sehat')">Makan Sehat</button>
        <button class="tag-toggle" onclick="toggleTag(this,'kerja')">Kerja</button>
        <button class="tag-toggle" onclick="toggleTag(this,'sosial')">Sosial</button>
        <button class="tag-toggle" onclick="toggleTag(this,'keluarga')">Keluarga</button>
        <button class="tag-toggle" onclick="toggleTag(this,'self-care')">Self-care</button>
        <button class="tag-toggle" onclick="toggleTag(this,'stres')">Stres</button>
        <button class="tag-toggle" onclick="toggleTag(this,'sakit')">Sakit</button>
        <button class="tag-toggle" onclick="toggleTag(this,'bahagia')">Bahagia</button>
        <button class="tag-toggle" onclick="toggleTag(this,'produktif')">Produktif</button>
      </div>

      <!-- Prompt suggestions -->
      <div style="margin-top:16px;padding:12px;background:var(--bg-elevated);border-radius:var(--radius);border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Pertanyaan Refleksi</div>
        <div id="prompt-text" style="font-size:13px;color:var(--text-secondary);line-height:1.6;cursor:pointer;" onclick="nextPrompt()"></div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">Ketuk untuk pertanyaan lain</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" style="flex:1;" onclick="closeEditor()">Batal</button>
      <button class="btn btn-primary" style="flex:2;" onclick="saveEntry()">Simpan Jurnal</button>
    </div>
  </div>
</div>

<!-- ===== VIEW MODAL ===== -->
<div class="modal-overlay hidden" id="view-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="view-title">Detail Jurnal</div>
      <button class="icon-btn" onclick="closeView()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="view-modal-body" id="view-body"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" style="flex:1;color:var(--error);border-color:rgba(220,38,38,0.25);" onclick="deleteCurrentEntry()">Hapus</button>
      <button class="btn btn-ghost" style="flex:1;" onclick="editCurrentEntry()">Edit</button>
      <button class="btn btn-primary" style="flex:1;" onclick="closeView()">Tutup</button>
    </div>
  </div>
</div>

<!-- ===== FILTER MODAL ===== -->
<div class="modal-overlay hidden" id="filter-modal">
  <div class="modal-sheet" style="max-height:50dvh;">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Filter Jurnal</div>
      <button class="icon-btn" onclick="closeFilter()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="padding:16px 20px;">
      <div style="display:flex;flex-direction:column;gap:8px;" id="filter-opts">
        <button class="tag-toggle active" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('all',this)">Semua Entri</button>
        <button class="tag-toggle" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('sangat-baik',this)">&#128513; Luar Biasa</button>
        <button class="tag-toggle" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('baik',this)">&#128512; Baik</button>
        <button class="tag-toggle" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('biasa',this)">&#128528; Biasa</button>
        <button class="tag-toggle" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('kurang',this)">&#128544; Kurang</button>
        <button class="tag-toggle" style="text-align:left;padding:10px 14px;border-radius:var(--radius);" onclick="applyFilter('buruk',this)">&#128549; Buruk</button>
      </div>
    </div>
  </div>
</div>

<script src="../assets/js/utils.js"></script>
<script>
if (!MediZen.auth.isLoggedIn()) window.location.href = '../auth/login.html';

// ─── Mood config ──────────────────────────────────────────────────────────────
const MOODS = {
  'sangat-baik': { icon: '\u{1F601}', label: 'Luar Biasa', color: 'var(--accent-green)' },
  'baik':        { icon: '\u{1F600}', label: 'Baik',        color: 'var(--accent-blue)' },
  'biasa':       { icon: '\u{1F610}', label: 'Biasa',       color: 'var(--accent-yellow)' },
  'kurang':      { icon: '\u{1F620}', label: 'Kurang',      color: 'var(--accent-orange)' },
  'buruk':       { icon: '\u{1F625}', label: 'Buruk',       color: 'var(--error)' }
};

const PROMPTS = [
  'Apa momen terbaik hari ini yang membuatmu merasa bersyukur?',
  'Hal apa yang sedang kamu khawatirkan? Apakah itu bisa kamu kendalikan?',
  'Bagaimana kondisi tubuhmu hari ini? Apa yang perlu lebih diperhatikan?',
  'Apa satu hal kecil yang bisa kamu lakukan untuk merawat dirimu sendiri hari ini?',
  'Siapa orang yang membuat harimu lebih baik? Sudahkah kamu berterima kasih?',
  'Apa pelajaran terbesar yang kamu ambil dari hari ini?',
  'Pada skala 1-10, seberapa baik kamu merawat dirimu hari ini? Kenapa?',
  'Apa yang membuatmu lelah hari ini? Bagaimana cara mengatasinya?',
  'Apa satu kebiasaan sehat yang berhasil kamu lakukan hari ini?',
  'Jika kamu bisa mengubah satu hal dari hari ini, apa itu?'
];

let promptIdx = Math.floor(Math.random() * PROMPTS.length);

// ─── State ────────────────────────────────────────────────────────────────────
let entries = MediZen.storage.get('journal_entries') || [];
let currentFilter = 'all';
let editingId = null;
let viewingId = null;
let editorMood = 'sangat-baik';
let selectedTags = [];
let todayMood = null;

// ─── Init ─────────────────────────────────────────────────────────────────────
function init() {
  // Set today label
  document.getElementById('today-label').textContent = new Date().toLocaleDateString('id-ID', {
    weekday: 'short', day: 'numeric', month: 'short'
  });

  // Restore today's mood
  const savedTodayMood = MediZen.storage.get('today_mood');
  if (savedTodayMood && savedTodayMood.date === todayDateStr()) {
    todayMood = savedTodayMood.mood;
    document.querySelector(`[data-mood="${todayMood}"]`)?.classList.add('selected');
  }

  renderWeekDots();
  renderStats();
  renderInsight();
  renderEntries();
}

function todayDateStr() {
  const d = new Date();
  return d.toISOString().split('T')[0];
}

// ─── Today mood ───────────────────────────────────────────────────────────────
window.selectTodayMood = function(mood, el) {
  document.querySelectorAll('#mood-picker .mood-option').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
  todayMood = mood;
  MediZen.storage.set('today_mood', { mood, date: todayDateStr() });
  MediZen.toast('Mood hari ini disimpan!', 'success', 2000);
};

// ─── Week dots ────────────────────────────────────────────────────────────────
function renderWeekDots() {
  const wrap = document.getElementById('week-dots');
  const days = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
  const today = new Date();
  let html = '';
  for (let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const dayName = days[d.getDay()];
    const isTodayDay = i === 0;
    const isFuture = i < 0;

    // Find entry for this day
    const dayEntry = entries.filter(e => e.date.startsWith(dateStr));
    const moodForDay = dayEntry.length ? dayEntry[dayEntry.length - 1].mood : null;
    const icon = moodForDay ? MOODS[moodForDay]?.icon : '';
    const cls = isFuture ? 'future' : isTodayDay ? 'today' : '';

    html += `<div class="week-dot-item">
      <div class="week-dot ${cls}">${icon || (isTodayDay ? '' : '')}</div>
      <div class="week-dot-label">${dayName}</div>
    </div>`;
  }
  wrap.innerHTML = html;
}

// ─── Stats ────────────────────────────────────────────────────────────────────
function renderStats() {
  document.getElementById('total-val').textContent = entries.length;

  const now = new Date();
  const thisMonth = entries.filter(e => {
    const d = new Date(e.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  }).length;
  document.getElementById('this-month-val').textContent = thisMonth;

  // Calculate streak
  let streak = 0;
  const today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const hasEntry = entries.some(e => e.date.startsWith(dateStr));
    if (hasEntry) streak++;
    else if (i > 0) break;
  }
  document.getElementById('streak-val').textContent = streak;
}

// ─── Insight bars ─────────────────────────────────────────────────────────────
function renderInsight() {
  if (entries.length < 3) {
    document.getElementById('insight-card').style.display = 'none';
    return;
  }
  document.getElementById('insight-card').style.display = 'block';

  const counts = {};
  entries.forEach(e => { counts[e.mood] = (counts[e.mood] || 0) + 1; });
  const maxCount = Math.max(...Object.values(counts));

  const html = Object.entries(MOODS).map(([key, m]) => {
    const count = counts[key] || 0;
    const pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
    return `<div class="mood-bar-row">
      <div class="mood-bar-label">${m.icon}</div>
      <div class="mood-bar-track"><div class="mood-bar-fill" style="width:${pct}%;"></div></div>
      <div class="mood-bar-count">${count}</div>
    </div>`;
  }).join('');

  document.getElementById('mood-bars').innerHTML = html;
}

// ─── Render entries ───────────────────────────────────────────────────────────
function renderEntries() {
  const list = document.getElementById('journal-list');
  const empty = document.getElementById('journal-empty');

  let filtered = currentFilter === 'all' ? [...entries] : entries.filter(e => e.mood === currentFilter);
  filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

  if (!filtered.length) {
    list.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  list.innerHTML = filtered.map(entry => {
    const mood = MOODS[entry.mood] || MOODS['biasa'];
    const date = new Date(entry.date);
    const dateStr = date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    const wordCount = (entry.body || '').split(/\s+/).filter(Boolean).length;
    const tagsHtml = (entry.tags || []).map(t => `<span class="entry-tag">${t}</span>`).join('');

    return `<div class="journal-entry-card" onclick="viewEntry('${entry.id}')">
      <div class="entry-header">
        <div class="entry-mood-badge">${mood.icon}</div>
        <div class="entry-meta">
          <div class="entry-date">${entry.title || dateStr}</div>
          <div class="entry-time">${timeStr} &middot; ${dateStr.split(',')[0] || ''}</div>
        </div>
        <div class="entry-mood-label" style="color:${mood.color};">${mood.label}</div>
      </div>
      ${entry.body ? `<div class="entry-preview">${entry.body}</div>` : ''}
      ${entry.tags && entry.tags.length ? `<div class="entry-tags">${tagsHtml}</div>` : ''}
      <div class="entry-stats">
        <div class="entry-stat">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/></svg>
          ${wordCount} kata
        </div>
        ${entry.tags && entry.tags.length ? `<div class="entry-stat">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          ${entry.tags.length} tag
        </div>` : ''}
      </div>
    </div>`;
  }).join('');
}

// ─── Editor ───────────────────────────────────────────────────────────────────
window.openEditor = function(id) {
  editingId = id;
  editorMood = 'sangat-baik';
  selectedTags = [];

  if (id) {
    const entry = entries.find(e => e.id === id);
    if (!entry) return;
    document.getElementById('editor-title').textContent = 'Edit Jurnal';
    document.getElementById('entry-title-input').value = entry.title || '';
    document.getElementById('entry-body').value = entry.body || '';
    editorMood = entry.mood || 'sangat-baik';
    selectedTags = [...(entry.tags || [])];
  } else {
    document.getElementById('editor-title').textContent = 'Jurnal Baru';
    document.getElementById('entry-title-input').value = '';
    document.getElementById('entry-body').value = '';
    // Pre-select today's mood if set
    if (todayMood) editorMood = todayMood;
  }

  // Reset mood selector
  document.querySelectorAll('.editor-mood-opt').forEach(o => {
    o.classList.toggle('selected', o.dataset.mood === editorMood);
  });

  // Reset tags
  document.querySelectorAll('.tag-toggle').forEach(t => {
    t.classList.toggle('active', selectedTags.includes(t.textContent.toLowerCase().replace(' ', '-')));
  });

  // Word count
  updateWordCount();

  // Show prompt
  document.getElementById('prompt-text').textContent = PROMPTS[promptIdx];

  document.getElementById('editor-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('entry-body').focus(), 400);
};

window.closeEditor = function() {
  document.getElementById('editor-modal').classList.add('hidden');
  editingId = null;
};

window.selectEditorMood = function(mood, el) {
  editorMood = mood;
  document.querySelectorAll('.editor-mood-opt').forEach(o => o.classList.remove('selected'));
  el.classList.add('selected');
};

window.toggleTag = function(el, tag) {
  el.classList.toggle('active');
  if (el.classList.contains('active')) {
    if (!selectedTags.includes(tag)) selectedTags.push(tag);
  } else {
    selectedTags = selectedTags.filter(t => t !== tag);
  }
};

window.nextPrompt = function() {
  promptIdx = (promptIdx + 1) % PROMPTS.length;
  document.getElementById('prompt-text').textContent = PROMPTS[promptIdx];
};

document.getElementById('entry-body').addEventListener('input', updateWordCount);

function updateWordCount() {
  const val = document.getElementById('entry-body').value;
  const wc = val.split(/\s+/).filter(Boolean).length;
  document.getElementById('word-count').textContent = wc;
}

window.saveEntry = function() {
  const body = document.getElementById('entry-body').value.trim();
  if (!body) { MediZen.toast('Tulis isi jurnalmu dulu ya!', 'error'); return; }

  if (editingId) {
    const idx = entries.findIndex(e => e.id === editingId);
    if (idx !== -1) {
      entries[idx] = {
        ...entries[idx],
        title: document.getElementById('entry-title-input').value.trim(),
        body,
        mood: editorMood,
        tags: selectedTags,
        updatedAt: new Date().toISOString()
      };
    }
    MediZen.toast('Jurnal diperbarui!', 'success');
  } else {
    const newEntry = {
      id: 'j' + Date.now(),
      date: new Date().toISOString(),
      title: document.getElementById('entry-title-input').value.trim(),
      body,
      mood: editorMood,
      tags: selectedTags
    };
    entries.unshift(newEntry);
    MediZen.toast('Jurnal tersimpan!', 'success');
  }

  MediZen.storage.set('journal_entries', entries);
  closeEditor();
  renderEntries();
  renderStats();
  renderWeekDots();
  renderInsight();
};

// ─── View ─────────────────────────────────────────────────────────────────────
window.viewEntry = function(id) {
  viewingId = id;
  const entry = entries.find(e => e.id === id);
  if (!entry) return;

  const mood = MOODS[entry.mood] || MOODS['biasa'];
  const date = new Date(entry.date);
  const dateStr = date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

  document.getElementById('view-title').textContent = entry.title || dateStr;

  const tagsHtml = (entry.tags || []).length
    ? `<div class="entry-tags" style="margin-top:12px;">${entry.tags.map(t => `<span class="entry-tag">${t}</span>`).join('')}</div>`
    : '';

  document.getElementById('view-body').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;padding-bottom:16px;border-bottom:1px solid var(--border);margin-bottom:16px;">
      <div style="font-size:32px;">${mood.icon}</div>
      <div>
        <div style="font-family:var(--font-display);font-size:15px;font-weight:700;">${mood.label}</div>
        <div style="font-size:12px;color:var(--text-muted);">${dateStr} &middot; ${timeStr}</div>
      </div>
    </div>
    <div class="view-content-text">${entry.body}</div>
    ${tagsHtml}
  `;

  document.getElementById('view-modal').classList.remove('hidden');
};

window.closeView = function() {
  document.getElementById('view-modal').classList.add('hidden');
  viewingId = null;
};

window.deleteCurrentEntry = function() {
  if (!viewingId) return;
  if (!confirm('Hapus jurnal ini? Tindakan tidak bisa dibatalkan.')) return;
  entries = entries.filter(e => e.id !== viewingId);
  MediZen.storage.set('journal_entries', entries);
  closeView();
  renderEntries();
  renderStats();
  renderWeekDots();
  renderInsight();
  MediZen.toast('Jurnal dihapus', 'info');
};

window.editCurrentEntry = function() {
  const id = viewingId;
  closeView();
  openEditor(id);
};

// ─── Filter ───────────────────────────────────────────────────────────────────
window.toggleFilter = function() {
  document.getElementById('filter-modal').classList.remove('hidden');
};

window.closeFilter = function() {
  document.getElementById('filter-modal').classList.add('hidden');
};

window.applyFilter = function(mood, el) {
  currentFilter = mood;
  document.querySelectorAll('#filter-opts button').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  const labels = { all: 'Semua', 'sangat-baik': 'Luar Biasa', baik: 'Baik', biasa: 'Biasa', kurang: 'Kurang', buruk: 'Buruk' };
  document.getElementById('filter-label').textContent = labels[mood] || 'Semua';
  closeFilter();
  renderEntries();
};

// Close modals on overlay click
['editor-modal','view-modal','filter-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', function(e) {
    if (e.target === this) {
      if (id === 'editor-modal') closeEditor();
      else if (id === 'view-modal') closeView();
      else if (id === 'filter-modal') closeFilter();
    }
  });
});

// Add sample entries if empty (seed data)
if (entries.length === 0) {
  const seedDates = [1, 2, 4, 5, 6];
  const seedMoods = ['baik', 'sangat-baik', 'biasa', 'kurang', 'baik'];
  const seedTexts = [
    'Hari ini cukup produktif. Berhasil menyelesaikan beberapa tugas yang sudah lama tertunda. Merasa lebih lega dan energi terasa cukup baik sepanjang hari.',
    'Hari yang luar biasa! Bertemu teman lama dan ngobrol panjang. Rasanya menyenangkan sekali punya waktu untuk diri sendiri dan orang-orang yang berarti.',
    'Tidak ada yang spesial hari ini. Rutinitas biasa, tapi setidaknya semua berjalan lancar tanpa masalah besar. Mungkin perlu lebih banyak variasi.',
    'Merasa sedikit overwhelmed dengan pekerjaan. Perlu ingat untuk istirahat lebih sering dan tidak terlalu keras pada diri sendiri.',
    'Olahraga pagi tadi sangat membantu mood. Merasa lebih segar dan fokus. Harus lebih konsisten dengan rutinitas ini.'
  ];

  seedDates.forEach((daysAgo, i) => {
    const d = new Date();
    d.setDate(d.getDate() - daysAgo);
    entries.push({
      id: 'seed' + i,
      date: d.toISOString(),
      title: '',
      body: seedTexts[i],
      mood: seedMoods[i],
      tags: [['produktif','kerja'], ['sosial','bahagia'], [], ['stres','kerja'], ['olahraga','self-care']][i]
    });
  });
  MediZen.storage.set('journal_entries', entries);
}

init();
</script>
</body>
</html>
