<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Detail Produk ‚Äî MediZen</title>
<link rel="stylesheet" href="pharmacy.css">
</head>
<body>
<div class="app-shell">
  <div class="pharma-detail" id="detail-wrap" style="display:none">

    <!-- Header -->
    <div class="detail-header">
      <a href="index.html" class="icon-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
      </a>
      <div class="pharmacy-title">Detail Produk</div>
      <button class="icon-btn" id="wishlist-btn" onclick="toggleWishlist()" title="Wishlist">
        <svg id="wishlist-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      <div class="cart-btn" onclick="openCart()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
        <div class="cart-badge hidden" id="cart-badge">0</div>
      </div>
    </div>

    <!-- Product Thumb -->
    <div class="detail-thumb" id="det-thumb">
      <span class="detail-thumb-emoji">üíä</span>
      <div class="detail-thumb-bg" id="det-thumb-bg"></div>
    </div>

    <!-- Main info -->
    <div class="detail-main">
      <div class="det-top-row">
        <div class="detail-category-badge" id="det-cat"></div>
        <div class="det-rating-pill" id="det-rating"></div>
      </div>
      <div class="detail-brand" id="det-brand">Brand</div>
      <div class="detail-name" id="det-name">Nama Produk</div>
      <div class="detail-price" id="det-price">Rp 0</div>

      <!-- Stock + sold -->
      <div class="det-stock-row" id="det-stock-row"></div>

      <!-- Separator -->
      <div class="det-sep"></div>

      <!-- Qty + CTA -->
      <div class="det-qty-row">
        <div class="qty-control">
          <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
          <span class="qty-val" id="qty-val">1</span>
          <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
        <div class="det-cta-group">
          <button class="btn btn-outline" onclick="addToCart()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            Keranjang
          </button>
          <button class="btn btn-primary" onclick="buyNow()" style="flex:1">Beli Sekarang</button>
        </div>
      </div>
    </div>

    <!-- Features strip -->
    <div class="det-features">
      <div class="det-feature">
        <div class="det-feature-icon">üöö</div>
        <div class="det-feature-lbl">Same Day</div>
      </div>
      <div class="det-feature-sep"></div>
      <div class="det-feature">
        <div class="det-feature-icon">‚úÖ</div>
        <div class="det-feature-lbl">BPOM</div>
      </div>
      <div class="det-feature-sep"></div>
      <div class="det-feature">
        <div class="det-feature-icon">üîÑ</div>
        <div class="det-feature-lbl">Return 7 hari</div>
      </div>
      <div class="det-feature-sep"></div>
      <div class="det-feature">
        <div class="det-feature-icon">üè•</div>
        <div class="det-feature-lbl">Apotek Resmi</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="detail-tabs">
      <div class="detail-tab active" onclick="switchTab('desc', this)">Deskripsi</div>
      <div class="detail-tab" onclick="switchTab('comp', this)">Komposisi</div>
      <div class="detail-tab" onclick="switchTab('usage', this)">Aturan Pakai</div>
      <div class="detail-tab" onclick="switchTab('side', this)">Efek Samping</div>
    </div>
    <div class="detail-tab-content active" id="tab-desc"></div>
    <div class="detail-tab-content" id="tab-comp"></div>
    <div class="detail-tab-content" id="tab-usage"></div>
    <div class="detail-tab-content" id="tab-side"></div>

    <!-- Related products -->
    <div class="related-section">
      <div class="related-title">Produk Terkait</div>
      <div class="related-grid" id="related-grid"></div>
    </div>

  </div>

  <!-- Cart Modal -->
  <div class="cart-modal" id="cart-modal">
    <div class="cart-sheet">
      <div class="cart-handle"></div>
      <div class="cart-head">
        <div class="cart-title">Keranjang Belanja üõí</div>
        <button class="icon-btn" onclick="closeCart()" style="border:none;background:var(--bg-elevated);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="cart-body" id="cart-body"></div>
      <div class="cart-foot" id="cart-foot" style="display:none">
        <div class="shipping-bar" id="shipping-bar">
          <span id="shipping-status">üöö Tambah lebih banyak untuk gratis ongkir</span>
        </div>
        <div class="cart-total">
          <div>
            <div style="color:var(--text-muted);font-size:11px;margin-bottom:2px">Total Pembayaran</div>
            <div class="cart-total-val" id="cart-total">Rp 0</div>
          </div>
          <button class="btn btn-primary" onclick="doCheckout()" style="padding:12px 20px;gap:6px">
            Checkout
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success-overlay hidden" id="success-overlay">
    <div class="success-card">
      <div class="success-icon-wrap">
        <div class="success-checkmark">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
      </div>
      <div class="success-title">Pesanan Berhasil!</div>
      <div class="success-subtitle">Pesananmu sedang diproses oleh apotek kami</div>
      <div class="success-details">
        <div class="success-detail-row">
          <span>No. Pesanan</span>
          <span id="order-number" style="font-weight:700;color:var(--primary)">#MZ-0000</span>
        </div>
        <div class="success-detail-row">
          <span>Estimasi Pengiriman</span>
          <span style="font-weight:600">1‚Äì3 jam</span>
        </div>
        <div class="success-detail-row">
          <span>Total Bayar</span>
          <span id="success-total" style="font-weight:700;color:var(--accent-blue)">Rp 0</span>
        </div>
      </div>
      <button class="btn btn-primary btn-full" onclick="closeSuccess()">Lanjut Belanja</button>
      <a href="../home/index.html" class="btn btn-outline btn-full" style="margin-top:10px">Ke Beranda</a>
    </div>
  </div>

  <!-- Bottom Nav -->
    <nav class="bottom-nav">
    <a href="../home/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span class="nav-label">Beranda</span>
    </a>
    <a href="../search/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span class="nav-label">Search</span>
    </a>
    <a href="../doctors/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Dokter</span>
    </a>
    <a href="../chatbot/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span class="nav-label">AI Chat</span>
    </a>
    <a href="../profile/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Profil</span>
    </a>
  </nav>
</div>

<script src="../assets/js/utils.js"></script>
<script>
if (!MediZen.auth.isLoggedIn()) window.location.href = '../auth/login.html';

const PRODUCTS = [
  { id:'p1', name:'Paracetamol 500mg', brand:'Generik', category:'obat', icon:'üíä', price:8500, rating:4.8, sold:1240, stock:500, tag:'Terlaris',
    desc:'Paracetamol adalah analgesik dan antipiretik yang digunakan untuk meredakan nyeri ringan hingga sedang dan menurunkan demam. Aman untuk semua usia bila digunakan sesuai dosis yang dianjurkan. Salah satu obat paling sering digunakan di dunia karena profil keamanannya yang baik.',
    comp:'Tiap tablet mengandung: Paracetamol 500mg. Eksipien: Pati jagung, Povidon, Asam stearat, Talk, Natrium starch glikolat.',
    usage:'Dewasa: 1-2 tablet tiap 4-6 jam, maksimal 8 tablet/hari. Anak 6-12 tahun: ¬Ω-1 tablet tiap 4-6 jam. Diminum dengan air putih. Jangan melebihi dosis yang dianjurkan.',
    side:'Jarang: reaksi alergi, ruam kulit. Overdosis dapat menyebabkan kerusakan hati yang serius. Hati-hati pada pasien dengan gangguan hati atau konsumsi alkohol tinggi.' },
  { id:'p2', name:'Vitamin C 1000mg Effervescent', brand:'Enervon-C', category:'vitamin', icon:'üçä', price:65000, rating:4.9, sold:980, stock:200, tag:'Terbaik',
    desc:'Suplemen vitamin C effervescent berkualitas tinggi untuk mendukung sistem imun, produksi kolagen, dan perlindungan antioksidan. Rasa jeruk segar yang menyegarkan, larut cepat dalam air, dan mudah dikonsumsi.',
    comp:'Tiap tablet effervescent mengandung: Vitamin C (Ascorbic Acid) 1000mg, Natrium Bikarbonat 450mg, Asam Sitrat, Manitol, Sorbitol, Perisa Jeruk Alami.',
    usage:'1 tablet dilarutkan dalam 200mL air, diminum 1 kali sehari. Sebaiknya dikonsumsi setelah makan untuk mengurangi iritasi lambung.',
    side:'Dosis tinggi dapat menyebabkan diare, mual, atau batu ginjal pada orang yang rentan. Hentikan penggunaan jika terjadi reaksi alergi.' },
  { id:'p3', name:'Omeprazole 20mg', brand:'Generik', category:'obat', icon:'üíä', price:22000, rating:4.6, sold:560, stock:150, tag:'',
    desc:'Omeprazole adalah penghambat pompa proton (PPI) yang mengurangi produksi asam lambung secara efektif. Digunakan untuk maag, GERD, tukak lambung, dan kondisi terkait asam lambung berlebih.',
    comp:'Tiap kapsul mengandung: Omeprazole 20mg dalam bentuk enteric-coated granul. Eksipien: Selulosa Mikrokristalin, Laktosa, Triethyl Citrate, HPMC.',
    usage:'1 kapsul sehari, diminum 30-60 menit sebelum makan. Telan kapsul utuh, jangan dikunyah atau dibuka. Durasi pengobatan sesuai petunjuk dokter.',
    side:'Dapat menyebabkan sakit kepala, diare, mual, atau nyeri perut. Penggunaan jangka panjang lebih dari 3 bulan perlu pengawasan dokter.' },
  { id:'p4', name:'Zinc + Vitamin D3 Kapsul', brand:'Blackmores', category:'suplemen', icon:'üí™', price:89000, rating:4.7, sold:430, stock:80, tag:'Promo',
    desc:'Kombinasi zinc dan vitamin D3 untuk mendukung sistem imun, kesehatan tulang, dan fungsi metabolisme. Formula premium dari Blackmores Australia dengan standar kualitas internasional.',
    comp:'Tiap kapsul mengandung: Zinc (sebagai Zinc Gluconate) 15mg, Vitamin D3 (Cholecalciferol) 400IU. Cangkang gelatin, Magnesium Stearate.',
    usage:'1 kapsul sehari bersama makanan. Untuk dosis terapi atau kebutuhan khusus sesuai anjuran dokter.',
    side:'Zinc dosis tinggi jangka panjang dapat mengganggu penyerapan tembaga. Simpan di tempat sejuk dan kering, jauh dari jangkauan anak-anak.' },
  { id:'p5', name:'Ibuprofen 400mg', brand:'Generik', category:'obat', icon:'üíä', price:12000, rating:4.5, sold:720, stock:300, tag:'',
    desc:'Ibuprofen adalah NSAID yang efektif untuk meredakan nyeri, demam, dan peradangan. Digunakan untuk nyeri kepala, nyeri haid, nyeri otot, sendi, dan artritis ringan.',
    comp:'Tiap tablet mengandung: Ibuprofen 400mg. Eksipien: Selulosa Mikrokristalin, Sodium Starch Glycolate, Silika koloidal anhidrat, Magnesium Stearat.',
    usage:'1 tablet tiap 4-6 jam bila perlu. Tidak lebih dari 3 tablet dalam 24 jam tanpa saran dokter. Diminum bersama makanan untuk mengurangi iritasi lambung.',
    side:'Dapat menyebabkan iritasi lambung, mual, pusing. Hindari pada pasien dengan tukak lambung, gangguan ginjal atau hati, atau alergi aspirin.' },
  { id:'p6', name:'Vitamin B Complex', brand:'Neurobion', category:'vitamin', icon:'üçÉ', price:35000, rating:4.6, sold:650, stock:250, tag:'',
    desc:'Suplemen lengkap vitamin B kompleks (B1, B6, B12) untuk mendukung kesehatan saraf, metabolisme energi, pembentukan sel darah merah, dan mengurangi kelelahan.',
    comp:'Tiap tablet mengandung: Vitamin B1 (Thiamine HCl) 100mg, Vitamin B6 (Pyridoxine HCl) 200mg, Vitamin B12 (Cyanocobalamin) 200mcg.',
    usage:'1 tablet per hari atau sesuai anjuran dokter. Diminum bersama makanan untuk penyerapan optimal.',
    side:'Umumnya aman. Dosis sangat tinggi B6 jangka panjang dapat menyebabkan neuropati perifer. Urin mungkin berwarna kuning terang, hal ini normal.' },
  { id:'p7', name:'Omega-3 Fish Oil 1000mg', brand:'Nu-Salt', category:'suplemen', icon:'üêü', price:115000, rating:4.8, sold:320, stock:60, tag:'Premium',
    desc:'Suplemen minyak ikan omega-3 berkualitas tinggi yang kaya EPA dan DHA untuk mendukung kesehatan jantung, otak, dan mata. Dimurnikan dari logam berat.',
    comp:'Tiap kapsul mengandung: Minyak ikan 1000mg (EPA 180mg, DHA 120mg). Cangkang gelatin, Gliserin. Bebas merkuri.',
    usage:'1-2 kapsul per hari bersama makanan. Untuk efek optimal, konsumsi secara konsisten setiap hari.',
    side:'Dapat menyebabkan bau amis dari napas atau keringat. Dosis tinggi dapat mempengaruhi pembekuan darah. Hati-hati jika mengonsumsi obat antikoagulan.' },
  { id:'p8', name:'Tensimeter Digital', brand:'Omron', category:'alkes', icon:'ü©∫', price:320000, rating:4.9, sold:180, stock:30, tag:'Best Seller',
    desc:'Tensimeter digital otomatis lengan atas Omron untuk pemantauan tekanan darah yang akurat dan mudah di rumah. Layar besar, mudah dibaca, dan menyimpan riwayat 60 pengukuran.',
    comp:'1 unit tensimeter digital Omron HEM-7121, 1 manset ukuran standar (22-32cm), 4 baterai AA alkaline, panduan pengguna bahasa Indonesia, kotak penyimpanan.',
    usage:'Istirahat 5 menit sebelum pengukuran. Duduk tegak dengan punggung bersandar. Letakkan manset di lengan atas setinggi jantung. Tekan tombol START dan tunggu.',
    side:'Pastikan manset terpasang dengan benar untuk hasil akurat. Tidak untuk diagnosis medis profesional. Konsultasikan hasil abnormal dengan dokter.' },
  { id:'p9', name:'Cetirizine 10mg', brand:'Generik', category:'obat', icon:'üíä', price:15000, rating:4.4, sold:890, stock:400, tag:'',
    desc:'Cetirizine adalah antihistamin generasi ke-2 untuk meredakan gejala alergi seperti rhinitis alergi, urtikaria, gatal-gatal, dan konjungtivitis alergi. Efek mengantuk lebih rendah dari antihistamin generasi pertama.',
    comp:'Tiap tablet mengandung: Cetirizine HCl 10mg. Eksipien: Laktosa monohidrat, Selulosa Mikrokristalin, Povidon K30, Magnesium Stearat, Titanium Dioksida.',
    usage:'Dewasa dan anak lebih dari 12 tahun: 1 tablet (10mg) sekali sehari. Bisa diminum pagi atau malam hari sesuai kebutuhan.',
    side:'Dapat menyebabkan rasa kantuk ringan pada sebagian orang. Hindari mengemudi atau mengoperasikan mesin berat jika terasa mengantuk.' },
  { id:'p10', name:'Masker N95 (isi 10)', brand:'3M', category:'alkes', icon:'üò∑', price:75000, rating:4.8, sold:540, stock:100, tag:'',
    desc:'Masker respirator N95 standar 3M dengan efisiensi filtrasi lebih dari 95% untuk partikel udara berbahaya. Pelindungan optimal dari polusi, debu, dan partikel berbahaya.',
    comp:'10 lembar masker N95 3M model 8210. Bahan: Polipropilen non-woven, filter elektrostatik, tali elastis. Lulus standar NIOSH N95 dan EN149 FFP2.',
    usage:'Pasang masker menutupi hidung dan mulut sepenuhnya. Pastikan tepi masker menempel rapat ke wajah. Sekali pakai, buang setelah 8 jam penggunaan atau jika rusak.',
    side:'Tidak untuk penggunaan berulang. Ganti segera jika masker rusak, terkontaminasi, atau sulit bernafas. Tidak dirancang untuk anak-anak.' },
  { id:'p11', name:'Sunscreen SPF 50+ PA+++', brand:'Skin1004', category:'skincare', icon:'‚òÄÔ∏è', price:145000, rating:4.9, sold:760, stock:45, tag:'Trending',
    desc:'Sunscreen ringan SPF 50+ PA+++ dari Skin1004 untuk perlindungan maksimal dari sinar UVA dan UVB. Formula berbasis air dengan tekstur ringan, tidak lengket, cocok semua jenis kulit termasuk kulit sensitif.',
    comp:'Zinc Oxide, Titanium Dioxide, Niacinamide 5%, Centella Asiatica Extract, Hyaluronic Acid, Tocopheryl Acetate, Panthenol. Bebas paraben, alkohol, dan pewangi.',
    usage:'Oleskan secukupnya (2mg/cm¬≤) merata 15 menit sebelum terpapar sinar matahari. Ulangi setiap 2-3 jam saat beraktivitas outdoor atau setelah berenang.',
    side:'Hentikan pemakaian jika terjadi iritasi, kemerahan, atau ruam. Hindari kontak langsung dengan mata. Jauhkan dari jangkauan anak-anak di bawah 3 tahun.' },
  { id:'p12', name:'Probiotik Lacto-B', brand:'Lacto-B', category:'suplemen', icon:'ü¶†', price:55000, rating:4.7, sold:490, stock:90, tag:'',
    desc:'Suplemen probiotik dengan 3 strain bakteri baik untuk mendukung kesehatan saluran cerna, meningkatkan imunitas usus, mengatasi diare, dan menjaga keseimbangan mikrobioma.',
    comp:'Tiap sachet mengandung: Lactobacillus acidophilus (lebih dari 1√ó10‚Å∏ CFU), Bifidobacterium longum (lebih dari 1√ó10‚Å∑ CFU), Streptococcus thermophilus (lebih dari 1√ó10‚Å∑ CFU). Laktosa, fruktosa, perisa stroberi.',
    usage:'1 sachet, 2-3 kali sehari. Larutkan dalam air hangat (bukan panas lebih dari 40¬∞C). Bisa diminum langsung atau dicampur dengan makanan/minuman dingin.',
    side:'Pada beberapa orang mungkin menyebabkan perut kembung atau gas saat awal konsumsi, ini normal dan akan hilang. Simpan di lemari pendingin setelah dibuka.' },
];
MediZen.storage.set('products', PRODUCTS);

var qty = 1;
var currentProduct = null;
var isWishlisted = false;

function getCart() { return MediZen.storage.get('mz_cart') || []; }
function saveCart(c) { MediZen.storage.set('mz_cart', c); }

function updateCartBadge() {
  var cart = getCart();
  var total = cart.reduce(function(s,i){ return s + i.qty; }, 0);
  var badge = document.getElementById('cart-badge');
  if (total > 0) { badge.textContent = total > 9 ? '9+' : total; badge.classList.remove('hidden'); }
  else badge.classList.add('hidden');
}

var CAT_LABELS = { obat:'Obat Bebas', vitamin:'Vitamin', suplemen:'Suplemen', alkes:'Alat Kesehatan', skincare:'Skincare' };
var CAT_COLORS = {
  obat: 'rgba(88,166,255,0.2)', vitamin: 'rgba(240,192,96,0.2)',
  suplemen: 'rgba(57,211,83,0.2)', alkes: 'rgba(188,140,255,0.2)', skincare: 'rgba(247,129,102,0.2)'
};
var CAT_GRADIENTS = {
  obat: 'linear-gradient(135deg,rgba(88,166,255,0.12),rgba(10,186,181,0.04))',
  vitamin: 'linear-gradient(135deg,rgba(240,192,96,0.15),rgba(57,211,83,0.04))',
  suplemen: 'linear-gradient(135deg,rgba(57,211,83,0.12),rgba(10,186,181,0.04))',
  alkes: 'linear-gradient(135deg,rgba(188,140,255,0.12),rgba(88,166,255,0.04))',
  skincare: 'linear-gradient(135deg,rgba(247,129,102,0.12),rgba(240,192,96,0.04))',
};

function init() {
  var id = new URLSearchParams(window.location.search).get('id') || 'p1';
  var p = PRODUCTS.find(function(x){ return x.id === id; });
  if (!p) { window.location.href = 'index.html'; return; }
  currentProduct = p;

  document.title = p.name + ' ‚Äî MediZen';

  // Thumb
  document.querySelector('.detail-thumb-emoji').textContent = p.icon;
  document.getElementById('det-thumb-bg').style.background = CAT_GRADIENTS[p.category] || CAT_GRADIENTS.obat;

  // Info
  var catColor = CAT_COLORS[p.category] || 'rgba(10,186,181,0.2)';
  document.getElementById('det-cat').textContent = CAT_LABELS[p.category] || p.category;
  document.getElementById('det-cat').style.background = catColor;
  document.getElementById('det-cat').style.color = 'var(--text)';

  document.getElementById('det-rating').innerHTML = '‚≠ê ' + p.rating + ' &nbsp;¬∑&nbsp; ' + p.sold.toLocaleString('id-ID') + ' terjual';
  document.getElementById('det-brand').textContent = p.brand;
  document.getElementById('det-name').textContent = p.name;
  document.getElementById('det-price').textContent = 'Rp ' + p.price.toLocaleString('id-ID');

  var isLow = p.stock < 50;
  document.getElementById('det-stock-row').innerHTML =
    '<span class="' + (isLow ? 'stock-indicator low' : 'stock-indicator') + '">' +
      (isLow ? '‚ö†Ô∏è Stok terbatas: ' + p.stock : '‚úÖ Stok: ' + p.stock + '+') +
    '</span>' +
    (p.tag ? '<span class="product-tag" style="font-size:12px;padding:4px 10px">' + p.tag + '</span>' : '');

  // Tab content
  document.getElementById('tab-desc').innerHTML = '<p>' + p.desc + '</p>';
  document.getElementById('tab-comp').innerHTML = '<p>' + p.comp + '</p>';
  document.getElementById('tab-usage').innerHTML = '<p>' + p.usage + '</p>';
  document.getElementById('tab-side').innerHTML = '<div class="side-effect-box"><p>' + p.side + '</p></div>';

  // Wishlist state
  var wishlist = MediZen.storage.get('mz_wishlist') || [];
  isWishlisted = wishlist.indexOf(id) !== -1;
  updateWishlistIcon();

  // Related
  var related = PRODUCTS.filter(function(x){ return x.id !== id && x.category === p.category; }).slice(0,3);
  if (!related.length) related = PRODUCTS.filter(function(x){ return x.id !== id; }).slice(0,3);
  document.getElementById('related-grid').innerHTML = related.map(function(r) {
    return '<a href="detail.html?id=' + r.id + '" class="related-card">' +
      '<div class="related-thumb" style="background:' + (CAT_GRADIENTS[r.category] || CAT_GRADIENTS.obat) + '">' + r.icon + '</div>' +
      '<div class="related-name">' + r.name + '</div>' +
      '<div class="related-price">Rp ' + r.price.toLocaleString('id-ID') + '</div>' +
    '</a>';
  }).join('');

  document.getElementById('detail-wrap').style.display = 'block';
  updateCartBadge();
}

function toggleWishlist() {
  var wishlist = MediZen.storage.get('mz_wishlist') || [];
  var id = currentProduct.id;
  var idx = wishlist.indexOf(id);
  if (idx === -1) { wishlist.push(id); isWishlisted = true; MediZen.toast('Ditambahkan ke wishlist ‚ù§Ô∏è', 'success'); }
  else { wishlist.splice(idx, 1); isWishlisted = false; MediZen.toast('Dihapus dari wishlist', 'error'); }
  MediZen.storage.set('mz_wishlist', wishlist);
  updateWishlistIcon();
}

function updateWishlistIcon() {
  var icon = document.getElementById('wishlist-icon');
  if (isWishlisted) {
    icon.setAttribute('fill', '#F78166');
    icon.setAttribute('stroke', '#F78166');
  } else {
    icon.setAttribute('fill', 'none');
    icon.setAttribute('stroke', 'currentColor');
  }
}

function switchTab(tabId, el) {
  document.querySelectorAll('.detail-tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.detail-tab-content').forEach(function(t){ t.classList.remove('active'); });
  el.classList.add('active');
  document.getElementById('tab-' + tabId).classList.add('active');
}

function changeQty(delta) {
  qty = Math.max(1, qty + delta);
  document.getElementById('qty-val').textContent = qty;
}

function addToCart() {
  if (!currentProduct) return;
  var cart = getCart();
  var existing = cart.find(function(i){ return i.id === currentProduct.id; });
  if (existing) existing.qty += qty;
  else cart.push({ id: currentProduct.id, name: currentProduct.name, price: currentProduct.price, icon: currentProduct.icon, qty: qty });
  saveCart(cart);
  updateCartBadge();
  MediZen.toast(currentProduct.name + ' √ó' + qty + ' ditambahkan üõí', 'success');
}

function buyNow() { addToCart(); openCart(); }

function openCart() { renderCart(); document.getElementById('cart-modal').classList.add('active'); }
function closeCart() { document.getElementById('cart-modal').classList.remove('active'); }

function renderCart() {
  var cart = getCart();
  var body = document.getElementById('cart-body');
  var foot = document.getElementById('cart-foot');
  if (!cart.length) {
    body.innerHTML = '<div class="empty-cart"><div class="empty-cart-icon">üõí</div><div>Keranjangmu masih kosong</div></div>';
    foot.style.display = 'none'; return;
  }
  body.innerHTML = cart.map(function(item) {
    return '<div class="cart-item">' +
      '<div class="cart-item-thumb">' + item.icon + '</div>' +
      '<div class="cart-item-info">' +
        '<div class="cart-item-name">' + item.name + '</div>' +
        '<div class="cart-item-price">Rp ' + (item.price * item.qty).toLocaleString('id-ID') + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">@ Rp ' + item.price.toLocaleString('id-ID') + '</div>' +
      '</div>' +
      '<div class="cart-qty-wrap">' +
        '<button class="qty-btn-sm" onclick="changeCartQty(\'' + item.id + '\',-1)">‚àí</button>' +
        '<span class="qty-num">' + item.qty + '</span>' +
        '<button class="qty-btn-sm" onclick="changeCartQty(\'' + item.id + '\',1)">+</button>' +
      '</div>' +
    '</div>';
  }).join('');

  var total = cart.reduce(function(s,i){ return s + i.price * i.qty; }, 0);
  document.getElementById('cart-total').textContent = 'Rp ' + total.toLocaleString('id-ID');

  var FREE_SHIPPING = 75000;
  var remaining = Math.max(0, FREE_SHIPPING - total);
  var shippingEl = document.getElementById('shipping-status');
  if (remaining <= 0) {
    shippingEl.innerHTML = '‚úÖ Selamat! Kamu mendapat <strong>gratis ongkir</strong>';
    shippingEl.style.color = 'var(--accent-green)';
  } else {
    shippingEl.innerHTML = 'üöö Tambah <strong>Rp ' + remaining.toLocaleString('id-ID') + '</strong> lagi untuk gratis ongkir';
    shippingEl.style.color = '';
  }
  foot.style.display = 'block';
}

function changeCartQty(id, delta) {
  var cart = getCart();
  var item = cart.find(function(i){ return i.id === id; });
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(function(i){ return i.id !== id; });
  saveCart(cart);
  updateCartBadge();
  renderCart();
}

function doCheckout() {
  var cart = getCart();
  var total = cart.reduce(function(s,i){ return s + i.price * i.qty; }, 0);
  var orderNum = '#MZ-' + Math.floor(1000 + Math.random() * 9000);
  var orders = MediZen.storage.get('mz_orders') || [];
  orders.unshift({ id: orderNum, items: cart, total: total, date: new Date().toISOString(), status: 'processing' });
  MediZen.storage.set('mz_orders', orders);
  saveCart([]);
  updateCartBadge();
  closeCart();
  document.getElementById('order-number').textContent = orderNum;
  document.getElementById('success-total').textContent = 'Rp ' + total.toLocaleString('id-ID');
  document.getElementById('success-overlay').classList.remove('hidden');
}

function closeSuccess() {
  document.getElementById('success-overlay').classList.add('hidden');
}

document.getElementById('cart-modal').addEventListener('click', function(e) {
  if (e.target === this) closeCart();
});

init();
</script>
</body>
</html>
