<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Buat Janji â€” MediZen</title>
<link rel="stylesheet" href="booking.css">
</head>
<body>
<div class="app-shell">

  <div class="booking-header">
    <a href="../doctors/index.html" id="back-btn" class="icon-btn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
    </a>
    <div class="booking-header-title" id="header-title">Buat Janji</div>
  </div>

  <!-- Progress -->
  <div class="steps-wrap" id="steps-wrap">
    <div class="steps-row">
      <div class="step-item">
        <div class="step-circle active" id="sc1">1</div>
        <div class="step-label active" id="sl1">Data</div>
      </div>
      <div class="step-line" id="line12"></div>
      <div class="step-item">
        <div class="step-circle" id="sc2">2</div>
        <div class="step-label" id="sl2">Jadwal</div>
      </div>
      <div class="step-line" id="line23"></div>
      <div class="step-item">
        <div class="step-circle" id="sc3">3</div>
        <div class="step-label" id="sl3">Konfirmasi</div>
      </div>
    </div>
  </div>

  <div class="booking-page" id="booking-page">

    <!-- STEP 1: Patient Info -->
    <div class="step-panel active" id="panel1">
      <div id="doc-summary-1"></div>
      <div class="form-section-title">Data Pasien</div>
      <div class="form-stack">
        <div class="input-group">
          <div class="input-label">Nama Lengkap</div>
          <div class="input-wrapper">
            <input class="input-field" type="text" id="patient-name" placeholder="Nama sesuai KTP">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Nomor Telepon</div>
          <div class="input-wrapper">
            <input class="input-field" type="tel" id="patient-phone" placeholder="08xx xxxx xxxx">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Tanggal Lahir</div>
          <div class="input-wrapper">
            <input class="input-field" type="date" id="patient-dob">
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Keluhan Utama</div>
          <div class="input-wrapper">
            <textarea class="input-field" id="patient-complaint" rows="3" placeholder="Ceritakan keluhan yang ingin dikonsultasikan..." style="resize:none;line-height:1.5;"></textarea>
          </div>
        </div>
        <div class="input-group">
          <div class="input-label">Jenis Konsultasi</div>
          <div class="radio-group">
            <div class="radio-card selected" data-type="online" onclick="selectType('online')">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
              <span class="rc-label">Online</span>
            </div>
            <div class="radio-card" data-type="offline" onclick="selectType('offline')">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
              <span class="rc-label">Di Klinik</span>
            </div>
            <div class="radio-card" data-type="homevisit" onclick="selectType('homevisit')">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              <span class="rc-label">Home Visit</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 2: Schedule -->
    <div class="step-panel" id="panel2">
      <div id="doc-summary-2"></div>
      <div class="form-section-title">Pilih Tanggal</div>
      <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;margin-bottom:20px;">
        <div class="calendar-header">
          <button class="cal-nav" onclick="prevMonth()">&#8592;</button>
          <div class="cal-month" id="cal-month-label"></div>
          <button class="cal-nav" onclick="nextMonth()">&#8594;</button>
        </div>
        <div class="cal-days-header">
          <div class="cal-day-name">Min</div><div class="cal-day-name">Sen</div><div class="cal-day-name">Sel</div>
          <div class="cal-day-name">Rab</div><div class="cal-day-name">Kam</div><div class="cal-day-name">Jum</div><div class="cal-day-name">Sab</div>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
      </div>

      <div class="form-section-title">Pilih Waktu</div>
      <div class="time-grid" id="time-grid"></div>
    </div>

    <!-- STEP 3: Confirmation -->
    <div class="step-panel" id="panel3">
      <div class="confirm-section">
        <div class="confirm-section-title">Detail Dokter</div>
        <div id="confirm-doc-rows"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-section-title">Detail Pasien</div>
        <div id="confirm-patient-rows"></div>
      </div>
      <div class="confirm-section">
        <div class="confirm-section-title">Jadwal & Jenis</div>
        <div id="confirm-schedule-rows"></div>
      </div>
      <div class="confirm-total">
        <div class="confirm-total-label">Total Pembayaran</div>
        <div id="confirm-total-price" class="confirm-total-price">-</div>
      </div>
      <div class="terms-check">
        <input type="checkbox" id="agree-terms">
        <label for="agree-terms">Saya setuju dengan <a href="#" onclick="return false;">Syarat & Ketentuan</a> serta <a href="#" onclick="return false;">Kebijakan Privasi</a> MediZen</label>
      </div>
    </div>

  </div>

  <!-- Bottom Bar -->
  <div class="step-bottom-bar" id="step-bar">
    <button class="btn btn-ghost btn-full" id="prev-btn" onclick="prevStep()" style="display:none;">Kembali</button>
    <button class="btn btn-primary btn-full" id="next-btn" onclick="nextStep()">Lanjut</button>
  </div>

    <nav class="bottom-nav">
    <a href="../home/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span class="nav-label">Beranda</span>
    </a>
    <a href="../search/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span class="nav-label">Search</span>
    </a>
    <a href="../doctors/index.html" class="nav-item active">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Dokter</span>
    </a>
    <a href="../chatbot/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span class="nav-label">AI Chat</span>
    </a>
    <a href="../profile/index.html" class="nav-item">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span class="nav-label">Profil</span>
    </a>
  </nav>
</div>

<script src="../assets/js/utils.js"></script>
<script>
if (!MediZen.auth.isLoggedIn()) window.location.href = '../auth/login.html';

const params = new URLSearchParams(location.search);
const docId = parseInt(params.get('id'));
const doctors = MediZen.storage.get('doctors') || [];
const doc = doctors.find(d => d.id === docId);

if (!doc) { window.location.href = '../doctors/index.html'; }

// Pre-fill user data
const user = MediZen.auth.getUser();
if (user) {
  const nameEl = document.getElementById('patient-name');
  if (nameEl) nameEl.value = user.name || '';
}

// State
let currentStep = 1;
let consultType = 'online';
let selectedDate = null;
let selectedTime = null;

// Calendar state
const today = new Date();
let calYear = today.getFullYear();
let calMonth = today.getMonth();

const MONTHS = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
const bookedTimes = ['10:00','14:00'];
const allTimes = ['08:00','09:00','10:00','11:00','13:00','14:00','15:00','16:00','17:00','18:00'];

function docSummaryHTML() {
  if (!doc) return '';
  const priceLabel = doc.price === 0 ? 'Gratis' : 'Rp ' + doc.price.toLocaleString('id-ID');
  return `<div class="doc-summary-card">
    <div class="doc-summary-avatar" style="background:${doc.color};">${doc.initials}</div>
    <div>
      <div class="doc-summary-name">${doc.name}</div>
      <div class="doc-summary-spec">${doc.specLabel}</div>
      <div style="margin-top:6px;font-size:12px;color:var(--accent-green);font-weight:600;">${priceLabel} / sesi</div>
    </div>
  </div>`;
}

document.getElementById('doc-summary-1').innerHTML = docSummaryHTML();
document.getElementById('doc-summary-2').innerHTML = docSummaryHTML();

function renderCalendar() {
  document.getElementById('cal-month-label').textContent = MONTHS[calMonth] + ' ' + calYear;
  const firstDay = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const daysInPrev = new Date(calYear, calMonth, 0).getDate();
  let cells = '';
  for (let i = 0; i < firstDay; i++) {
    cells += `<div class="cal-cell other-month">${daysInPrev - firstDay + i + 1}</div>`;
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const thisDate = new Date(calYear, calMonth, d);
    const isPast = thisDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const isToday = d === today.getDate() && calMonth === today.getMonth() && calYear === today.getFullYear();
    const isSelected = selectedDate && selectedDate.getDate() === d && selectedDate.getMonth() === calMonth && selectedDate.getFullYear() === calYear;
    let cls = 'cal-cell';
    if (isPast) cls += ' past';
    else if (isSelected) cls += ' selected';
    else if (isToday) cls += ' today';
    cells += `<div class="${cls}" onclick="${!isPast ? `pickDate(${d})` : ''}">${d}</div>`;
  }
  const total = firstDay + daysInMonth;
  const remaining = total % 7 === 0 ? 0 : 7 - (total % 7);
  for (let i = 1; i <= remaining; i++) {
    cells += `<div class="cal-cell other-month">${i}</div>`;
  }
  document.getElementById('cal-grid').innerHTML = cells;
}

function renderTimeGrid() {
  document.getElementById('time-grid').innerHTML = allTimes.map(t => {
    const isBooked = bookedTimes.includes(t);
    const isSel = t === selectedTime;
    return `<div class="time-pick ${isBooked?'booked':''} ${isSel?'selected':''}" onclick="${!isBooked?`pickTime('${t}')`:''}">
      ${t}
    </div>`;
  }).join('');
}

window.prevMonth = () => { calMonth--; if (calMonth < 0) { calMonth=11; calYear--; } renderCalendar(); };
window.nextMonth = () => { calMonth++; if (calMonth > 11) { calMonth=0; calYear++; } renderCalendar(); };

window.pickDate = (d) => {
  selectedDate = new Date(calYear, calMonth, d);
  selectedTime = null;
  renderCalendar();
  renderTimeGrid();
};

window.pickTime = (t) => {
  selectedTime = t;
  renderTimeGrid();
};

window.selectType = (type) => {
  consultType = type;
  document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
  document.querySelector(`[data-type="${type}"]`).classList.add('selected');
};

function updateSteps(step) {
  for (let i = 1; i <= 3; i++) {
    const sc = document.getElementById('sc'+i);
    const sl = document.getElementById('sl'+i);
    sc.className = 'step-circle ' + (i < step ? 'done' : i === step ? 'active' : '');
    sl.className = 'step-label ' + (i < step ? 'done' : i === step ? 'active' : '');
    if (i < step) sc.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>';
    else sc.textContent = i;
  }
  ['line12','line23'].forEach((id,idx) => {
    document.getElementById(id).className = 'step-line ' + (step > idx+1 ? 'done' : '');
  });
  document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel'+step).classList.add('active');
  document.getElementById('prev-btn').style.display = step > 1 ? 'block' : 'none';
  document.getElementById('next-btn').textContent = step === 3 ? 'Konfirmasi & Bayar' : 'Lanjut';
}

function buildConfirm() {
  if (!doc) return;
  const typeLabels = { online:'Konsultasi Online', offline:'Di Klinik', homevisit:'Home Visit' };
  const dateStr = selectedDate ? selectedDate.toLocaleDateString('id-ID',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : '-';
  const priceDisplay = doc.price === 0
    ? '<span style="color:var(--primary);">Gratis</span>'
    : 'Rp ' + doc.price.toLocaleString('id-ID');

  document.getElementById('confirm-doc-rows').innerHTML = [
    ['Dokter', doc.name],
    ['Spesialisasi', doc.specLabel],
    ['Rumah Sakit', doc.hospital],
  ].map(([k,v]) => `<div class="confirm-row"><span class="confirm-key">${k}</span><span class="confirm-val">${v}</span></div>`).join('');

  document.getElementById('confirm-patient-rows').innerHTML = [
    ['Nama', document.getElementById('patient-name').value || '-'],
    ['Telepon', document.getElementById('patient-phone').value || '-'],
    ['Keluhan', document.getElementById('patient-complaint').value || '-'],
  ].map(([k,v]) => `<div class="confirm-row"><span class="confirm-key">${k}</span><span class="confirm-val">${v}</span></div>`).join('');

  document.getElementById('confirm-schedule-rows').innerHTML = [
    ['Tanggal', dateStr],
    ['Waktu', selectedTime || '-'],
    ['Jenis', typeLabels[consultType]],
  ].map(([k,v]) => `<div class="confirm-row"><span class="confirm-key">${k}</span><span class="confirm-val">${v}</span></div>`).join('');

  document.getElementById('confirm-total-price').innerHTML = priceDisplay;
  const tp = document.getElementById('confirm-total-price');
  if (doc.price === 0) { tp.className = 'confirm-total-free'; } else { tp.className = 'confirm-total-price'; }
}

window.prevStep = () => {
  if (currentStep > 1) { currentStep--; updateSteps(currentStep); }
};

window.nextStep = () => {
  if (currentStep === 1) {
    const name = document.getElementById('patient-name').value.trim();
    const phone = document.getElementById('patient-phone').value.trim();
    const complaint = document.getElementById('patient-complaint').value.trim();
    if (!name || !phone || !complaint) { MediZen.toast('Mohon lengkapi semua data pasien', 'error'); return; }
    currentStep = 2;
    updateSteps(2);
    renderCalendar();
    renderTimeGrid();
  } else if (currentStep === 2) {
    if (!selectedDate) { MediZen.toast('Pilih tanggal konsultasi terlebih dahulu', 'error'); return; }
    if (!selectedTime) { MediZen.toast('Pilih waktu konsultasi terlebih dahulu', 'error'); return; }
    currentStep = 3;
    updateSteps(3);
    buildConfirm();
  } else if (currentStep === 3) {
    if (!document.getElementById('agree-terms').checked) { MediZen.toast('Setujui syarat & ketentuan terlebih dahulu', 'error'); return; }
    submitBooking();
  }
};

function submitBooking() {
  const btn = document.getElementById('next-btn');
  btn.disabled = true;
  btn.textContent = 'Memproses...';

  setTimeout(() => {
    const bookingId = 'MZ' + Date.now().toString(36).toUpperCase().slice(-6);
    const booking = {
      id: bookingId,
      doctorId: doc.id,
      doctorName: doc.name,
      doctorSpec: doc.specLabel,
      patientName: document.getElementById('patient-name').value,
      patientPhone: document.getElementById('patient-phone').value,
      complaint: document.getElementById('patient-complaint').value,
      type: consultType,
      date: selectedDate.toISOString(),
      time: selectedTime,
      price: doc.price,
      status: 'confirmed',
      createdAt: new Date().toISOString()
    };

    const bookings = MediZen.storage.get('bookings') || [];
    bookings.push(booking);
    MediZen.storage.set('bookings', bookings);

    // Show success screen
    document.getElementById('steps-wrap').style.display = 'none';
    document.getElementById('step-bar').style.display = 'none';
    document.getElementById('booking-page').innerHTML = `
      <div class="success-screen">
        <div class="success-icon-wrap">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#16A34A" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="success-title">Janji Berhasil Dibuat!</div>
        <div class="success-desc">Janji konsultasimu dengan <strong>${doc.name}</strong> telah dikonfirmasi. Kamu akan menerima pengingat sebelum sesi dimulai.</div>
        <div class="booking-id">
          <div class="booking-id-label">ID Pemesanan</div>
          <div class="booking-id-val">${bookingId}</div>
        </div>
        <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;width:100%;margin-bottom:28px;text-align:left;">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
            <span style="font-size:13px;color:var(--text-secondary);">Dokter</span>
            <span style="font-size:13px;font-weight:600;">${doc.name}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
            <span style="font-size:13px;color:var(--text-secondary);">Tanggal</span>
            <span style="font-size:13px;font-weight:600;">${selectedDate.toLocaleDateString('id-ID',{day:'numeric',month:'long',year:'numeric'})}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;">
            <span style="font-size:13px;color:var(--text-secondary);">Waktu</span>
            <span style="font-size:13px;font-weight:600;">${selectedTime} WIB</span>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;width:100%;">
          <a href="../home/index.html" class="btn btn-primary btn-full">Kembali ke Beranda</a>
          <a href="../doctors/index.html" class="btn btn-ghost btn-full">Cari Dokter Lain</a>
        </div>
      </div>`;
    document.getElementById('header-title').textContent = 'Konfirmasi Selesai';
  }, 1800);
}

updateSteps(1);
</script>
</body>
</html>
